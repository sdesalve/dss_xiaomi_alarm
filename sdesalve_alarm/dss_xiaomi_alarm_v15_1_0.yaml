### v15.1.0 del 24-08-2020
### sistemati loop per breaking changes sull'esecuzione degli script ("mode")
### pulizia e sistemazioni varie
### scheletro per l'aggiunta dei media player al posto del gateway Xiami

### v15.0.0 del 16-08-2020
### aggiunto supporto ai media player per i suoni

### v14.0.0 del 20-05-2020
### fix breaking changes HomeAssistant 0.110 in Manual Alarm Panel . Thanks to @alesoft73


### v13.2.0 del 27/11/2019
### aggiunta secret dss_triggers_menu_telegram_command_allarme per nuovo menù di comando dell'allarme con Telegram
### ### es:
### ###    dss_triggers_menu_telegram_command_allarme: '/alarm'


### v13.1.1 del 24/09/2019
### small fix in dss_xiaomi_alarm_notify_service.yaml


### v13.1.0 del 19/09/2019
### aggiunto controllo device_types nelle macro di controllo sensori finestre aperte.
### riscritte le macro per il controllo stato luci, clima ed infissi

### v12.0.0 del 17/08/2019
### aggiunte notifiche VoIP
### https://github.com/sdesalve/hassio-addons/tree/master/dss_voip

### v11.9.2 del 12/08/2019
### fix dss_play_triggered_sound_night

### v11.9.1 del 05/08/2019
### fix check volume TTS nello script dss_voice_riproduci_messaggio_tts - grazie alesoft73!

### v11.9 del 25/07/2019
### Aggiunti volume TTS Giorno e Notte. Se = 0 non vengono riprodotti nella fascia oraria corrispondente i messaggi TTS
### aggiunte automazioni avviso_tts_allarme_in_innesco_sensori_ritardati_away e avviso_tts_allarme_in_innesco_sensori_ritardati_home
### thanks jokerigno

### v11.8 del 14/07/2019
### sistemazioni ai gruppi e nascoste automazioni sensori ritardati e promemoria allarme attivo... abbassa i volumi a 0 se non vuoi che vengano riprodotti i suoni
### cambiato sistema di rilevazione gruppi dispositivi user1 e user2 in casa

### v11.7 del 20/06/2019
### aggiunti pulsanti e script alle notifiche telegram per spegnere le luci ed i condizionatori rimasti accesi. 
### grazie mille alesoft73!

### v11.6 del 19/06/2019
### rinominato servizio TTS da google_say a google_translate_say per evitare problemi a chi non ha specificato la KEY service_name nella definizione del TTS di Google
### sostituite tutte le esclusioni da states.input_select.xxxxxxxxxxx.attributes['options'] a state_attr('input_select.xxxxxxxxxxx', 'options')
### sostituite i template da states.input_select.xxxxxxxxxxx') a states('input_select.xxxxxxxxxxx')
### fix dss_procedura_reset_attivazione_rimandata: rimosse automation.automation.xxxxxxx
### cambiato da switch.ok_google_attiva_allarme a lock.ok_google_attiva_allarme, l'eventuale disattivazione dell'allarme richiederà un pin da comunicare all'assistente vocale
###    vedi 
###      https://www.home-assistant.io/components/google_assistant/#secure_devices_pin
###      e https://www.home-assistant.io/components/google_assistant/#secure-devices


### v11.5 del 17/06/2019
### aggiunte secrets 
# # dss_binary_sensor_secrets_ignora_controllo_luci_accese_home: ['nessuna']
# # dss_binary_sensor_secrets_ignora_controllo_luci_accese_away: ['nessuna']

# # dss_binary_sensor_secrets_ignora_controllo_clima_acceso_away: ['nessuno']
# # dss_binary_sensor_secrets_ignora_controllo_clima_acceso_home: ['nessuno']
### aggiunte notifiche all'attivazione dell'allarme con elenco luci e climatizzatori rimasti accesi



### v11.4 del 16/06/2019
### fix nome delle automazioni automation.elenca_infissi_aperti_su_click_pulsanti_away e automation.elenca_infissi_aperti_su_click_pulsanti_home. 
### All'attivazione dell'allarme se c'erano infissi aperti non venivano elencati se si faceva click.

### v11.3 del 11/06/2019
### fix nome degli infissi aperti nelle mnotifiche al posto dell'entity_id

### v11.2 del 04/06/2019
### aggiunto secondo Gateway di default. Nel caso non vi servisse, rimuovete tutti i riferimenti a gateway2



### v11.1 del 27/05/2019
### creato script dss_alarm_gateway_service_ferma_riproduzione_suoni per richiamare dss_alarm_script_ferma_riproduzione_suono_gateway1
### creato gruppo stato_gateway_service per contenere i controlli dei vari gateway
### Nascosta automazione spegni_lampeggiante_ad_attivazione_avvenuta e resa visibile accendi_lampeggiante_ad_attivazione_away_avvenuta
### Nascosta automazione accendi_flash_gateway_verde_su_disattivazione 
### Nascosta automazione conferma_infissi_chiusi_su_doppio_click_pulsante_ingresso 

### v11.0 del 25/05/2019
### rimossa dal gruppo automazioni globali l'automazione "accendi_lampeggiante_ad_attivazione_away_avvenuta". Tanto c'è input_boolean.dss_lights_on_away_mode
### rimossa secrets entity_pulsante_attiva_allarme_home2
### ottimizzazione files. Rimosso dss_xiaomi_alarm_sound_service.yaml



### v 10.9 del 08/05/2019
### fix Invia notifica se innescato AWAY ed Invia notifica se innescato HOME


### v 10.8 del 07/05/2019
### rinominata secrets entity_light_gateway in entity_light_gateway1
### rinominato script.dss_alarm_script_accendi_light_gateways in dss_alarm_script_accendi_luci_segnalazione
### rinominato script.dss_alarm_script_spegni_light_gateways in dss_alarm_script_spegni_luci_segnalazione



### v 10.8 del 05/05/2019
### aggiunte secrets all'esempio
### fix nomi sensori aperti
### fix click singolo tts elenco infissi aperti
### bugfix vari


### v 10.7 del 20/04/2019
### aggiunti sensori ritardati e input_number per impostare il ritardo dal triggering all'innesco
###     entity_sensore_innesco_ritardato_allarme_away: binary_sensor.door_window_sensor_xxxxxxxxxx
###     entity_sensore_innesco_ritardato_allarme_home: []
### rimosso delay innesco allarme in modalità AWAY

### cambiati da nomi a entity_id dei sensori da ignorare negli avvisi TTS
###     dss_binary_sensor_secrets_ignora_controllo_infissi_chiusi_home: [binary_sensor.motion_sensor_xxxxxxxxxxxxxx]
###     dss_binary_sensor_secrets_ignora_controllo_infissi_chiusi_away: [binary_sensor.motion_sensor_xxxxxxxxxxxxxx, binary_sensor.motion_sensor_yyyyyyyyyyyyyy]

### v 10.6 del 19/04/2019
### spostato controlli e script legati al Gateway Xiaomi in file esterno... Possibile duplicare il file dss_xiaomi_alarm_gateway1.yaml nel caso siano presenti più gateway
### Ulteriori News in arrivo...

### v 10.5 del 18/04/2019
### aggiunto switch esposto a google per sospendere l'attivazione automatica
### rinominate variabili per permettere la più semplice integrazione di 2 Gateway (da dss_gateway_xxxxx a dss_gateway1_xxxxx)
### spostati i nomi dei sensori da ignorare negli avvisi TTS dal file dell'allarme al secrets 
###     dss_binary_sensor_secrets_ignora_controllo_infissi_chiusi_home: ['Sensore_MOD']
###     dss_binary_sensor_secrets_ignora_controllo_infissi_chiusi_away: ['Sensore_MOD', 'Portoncino Ingresso']

### v 10.4 del 21/02/2019
### Pulizia di vecchie entity nei gruppi
### sistemati entity volume negli esempi per il 2° gateway
### Aggiunto promemoria allarme attivo anche in modalità home (vedi entity entity_sensore_promemoria_allarme_attivato_home)

### 10.3
### cambiato script dss_alarm_script_ferma_riproduzione_suono_gateway1e rimossi i dati del gateway. li prendo con il secret direttamente nel file dss_xiaomi_alarm_sound_service.yaml
### aggiunto codice di esempio per poter usare 2 gateway per la riproduzione dei suoni
### creati script dss_alarm_script_accendi_luci_segnalazione e dss_alarm_script_spegni_luci_segnalazione. Spostata la gestione della luce del gateay nel file dss_xiaomi_alarm_light_service.yaml

### 10.2 
### - splittato file in diversi file per semplificarne la personalizzazione e l'aggiornamento.
###   non dovrebbe più essere necessario modificare questo file
### - Cambiato frasi TTS

### 10.1
### sistemati esempi di stringhe da inserire nel secrets.yaml

### 10.0
### diviso il file allarme dagli utenti e aggiunto elenco degli infissi che innescano l'allarme nel secrets.yaml

### 9.4
### sistemate automazioni allarme attivato ed elenco infissi aperti

### 9.3
### rinominati gli eventi dei pulsanti XIAOMI per nuova versione di HASSIO
###    https://github.com/home-assistant/home-assistant/pull/17354

### 9.2
### Rimosso Google Assistant Webserver
  ### prima del messaggio riproduceva "Broadcast from mionome"
  ### vedi https://community.home-assistant.io/t/community-hass-io-add-on-google-assistant-webserver-broadcast-messages-without-interrupting-music/37274/476

### Aggiunto elenco infissi aperti alle notifiche di attivazione allarme

### 9.1
### bug fix

### 9.0
### corretto bug che non faceva riprodurre i suoni di allarme giorno/notte
### ripristinati suoni del gateway su disattivazione, promemoria apertura porta e altri
### se volume di qualsiasi suono = 0 non viene riprodotto
### aggiunte TTS per ogni cambio stato dell'allarme

### rinominato Switch di attivazione allarme in "Allarme"
### consiglio di escludere da Google Assistant gli switch "Allarme diurno attivato" e "Allarme nottuno attivato" aggiungendo alla configurazione di Google Assistant le seguenti righe:

  # entity_config:
    # switch.dss_alarm_giorno_attivo:
      # expose: false
   # switch.dss_alarm_notte_attivo:
      # expose: false

### 8.4
### rimosse le select delle suonerie
### rimossa la differenziazione delle suonerie HOME/AWAY per le modalità GIORNO/NOTTE

### 8.3
### Corretti value template di dss_alarm_giorno_attivo e dss_alarm_notte_attivo. Grazie a @alesoft73 per la segnalazione!
### Cambiato dss_alarm_giorno_attivo e dss_alarm_notte_attivo da binary_sensor a switch. Ora non solo indicano lo stato dell'allarme, ma spegnendoli si disattiva l'allarme. Accendendoli si attiva l'allarme in modalità home.

### 8.2
### 1) aggiornato il sistema di inserimento:
       # DOPPIO CLICK su pulsante
         # SE FINESTRE APERTE
            # AVVISO TTS: "Attenzione finestre aperte, clicca per conoscere quali.
                        #  L'allarme verrà inserito tra 30 secondi"
         # SE FINESTRE CHIUSE
            # AVVISO TTS: "Attivazione allarme in corso..."
###    2) inserite le linee orizzontali. Info su https://t.me/HomeAssistant

### 8.1
### bugfix
### integrato Google Assistant Web Server
### qui la guida: https://community.home-assistant.io/t/community-hass-io-add-on-google-assistant-webserver-broadcast-messages-without-interrupting-music/37274
### ATTENZIONE: Va aggiunto il servizio notify nel configuration.yaml dopo aver configurato l'add-on Google Webserver
### notify:
  ### - name: notifiche_tts
    ### platform: rest
    ### resource: http://[IP-del-RASPBERRY]:5000/broadcast_message

### 8.0
### 1) sistemato lampeggio verde su disattivato
### 2) aggiornato il sistema di inserimento:
       # DOPPIO CLICK su pulsante
         # SE FINESTRE APERTE
            # AVVISO TTS: "Attenzione finestre aperte, clicca per conoscere quali.
                        #  Fai doppio click per inserire comunque l'allarme"
            # BLOCCO INSERIMENTO (SE NON FAI DOPPIO CLICK ENTRO 30 SECONDI)
         # SE FINESTRE CHIUSE
            # AVVISO TTS: "Attivazione allarme in corso..."
### 3) rimpiazzate alcune suonerie con TTS
### 4) rimesse select per le suonerie (definite nel secrets) ed impostate quella di default con "initial"
### 5) nascosti alcuni script dalla default view

### 7.4 bugfix
### 7.3 bugfix

### 7.2 
# -1 Flash Verde quando spegni l'allarme.
# -2 Single Click Pulsante Ingresso, Elenco infissi Aperti dal Google Home, e se non ci fossero, riproduci "Tutti gli infissi sono chiusi"
# -3 Modifica la riproduzione "Attenzione, ci sono alcuni infissi aperti" aggiungendo "Klikka una volta per sapere quali" .
# -4 Possibilità di scegliere suoneria per Modalità Home e Away.
### grazie a Mr Jay (Ingrid) @mr_ingrid per i suggerimenti

### 7.1 ............... saltata

### 7.0 rimosse suonerie da secrets....##
### per rimettere la possibilità di scegliere le suonerie basta inserire al posto dell'unica option questo codice:
### options: !secret dss_options_elenco_suonerie_gateway1

### 6.9
### modificato messaggio vocale infissi chiusi in attivazione ed aggiunte le esclusioni

### 6.8 
### inserito controllo infissi aperti all'attivazione away e notifica tramite google mini

### 6.7
### fix lampeggiante in allarme attivato away

### 6.6
### ristemate le icone, i gruppi e nascoste le automazioni e gli script che non devono essere disattivati dall'utente.

### 6.5
### cambiati nomi notifiche

### 6.4
### correzione bug lampeggio su away

### 6.3
### - disattivato recorder
### - fermato suoni e lampeggiante dopo passaggio da TRIGGERED ad ARMED

### 6.2
### - aggiunto lampeggio 0.2s on e 30s off in caso di attivazione in modalità AWAY se "Lampeggia quando Allarme in modalità AWAY" è ON

###scarica questo package ed installalo vedi https://www.home-assistant.io/docs/configuration/packages/#create-a-packages-folder
### supporto su https://t.me/HomeAssistant ###

### developed by SDeSalve ###

alarm_control_panel:
  - platform: manual
    name: "Home Alarm"
    arming_time: 0 #pending_time: 0 #
    disarmed:
      trigger_time: 0
    armed_home:
      arming_time: 10 #pending_time: 0 #
      #nessun ritardo prima di far scattare l'allarme in caso di allarme HOME. Meglio che suoni subito!
      delay_time: 0
    armed_away:
      arming_time: 30 #pending_time: 0 #
      #ritardo prima di far scattare l'allarme in caso di allarme AWAY. 
      delay_time: 0

input_number:
  dss_delay_innesco_sensori_ritardati:
    name: "Ritardo innesco allarme sensori ritardati"
    icon: mdi:timer-sand
    min: 5
    max: 30
    step: 1
    unit_of_measurement: sec.
    
  dss_delay_riproduzione_suono_welcome:
    name: "Ritardo ripr. 'Promemoria'"
    icon: mdi:timer-sand
    min: 0
    max: 30
    step: 1
    unit_of_measurement: sec.

input_boolean:
  dss_sospesa_attivazione_automatica:
    name: "Sospendi attivazione automatica"
    icon: mdi:pause-circle

  dss_mute_gateway_sounds:
    name: "Silenzia allarme / Spegni lampeggiante"
    icon: mdi:volume-off

  dss_lights_on_away_mode:
    name: "Lampeggia ROSSO quando Allarme in modalità AWAY"
    icon: mdi:alarm-light
    initial: on
    
  dss_lights_on_disarmed_mode:
    name: "Lampeggia VERDE quando Allarme DISINSERITO"
    icon: mdi:alarm-light
    initial: on
    
  dss_necessaria_forzatura_attivazione:
    name: "Ignora infissi aperti"
    icon: mdi:alarm-light
    initial: off

### Input select to select sound to play ###
input_select:
  dss_binary_sensor_secrets_ignora_controllo_infissi_chiusi_home:
    options: !secret dss_binary_sensor_secrets_ignora_controllo_infissi_chiusi_home
            
  dss_binary_sensor_secrets_ignora_controllo_infissi_chiusi_away:
    options: !secret dss_binary_sensor_secrets_ignora_controllo_infissi_chiusi_away

  dss_binary_sensor_secrets_ignora_controllo_luci_accese_away:
    options: !secret dss_binary_sensor_secrets_ignora_controllo_luci_accese_away
            
  dss_binary_sensor_secrets_ignora_controllo_luci_accese_home:
    options: !secret dss_binary_sensor_secrets_ignora_controllo_luci_accese_home

  dss_binary_sensor_secrets_ignora_controllo_clima_acceso_away:
    options: !secret dss_binary_sensor_secrets_ignora_controllo_clima_acceso_away
            
  dss_binary_sensor_secrets_ignora_controllo_clima_acceso_home:
    options: !secret dss_binary_sensor_secrets_ignora_controllo_clima_acceso_home

binary_sensor:
  - platform: template
    sensors:
      dss_people_home:
        friendly_name: "Rilevati dispositivi tracciati in casa"
          #inserire qui i gruppi di dispositivi o i dispositivi singoli tracciati che fanno scattare l'inserimento automatico
        value_template: >-
          {{ is_state('group.dss_dispositivi_user1', 'home') or is_state('group.dss_dispositivi_user2', 'home') or is_state('group.dss_dispositivi_user4', 'home') or is_state('group.dss_dispositivi_user4', 'home') }}

  - platform: template
    sensors:
      dss_mode_giorno:
        friendly_name: "Modalità di funzionamento Giorno"
        #inserire qui l'ora di inizio e di fine della modalità giorno
        value_template: >-
          {{ states('sensor.time') > '07:00' and states('sensor.time') < '21:00' }}

  - platform: template
    sensors:
      dss_alarm_giorno_attivo:
        friendly_name: "Allarme diurno attivato"
        value_template: >-
          {{ is_state('binary_sensor.dss_mode_giorno', 'on') and not is_state('alarm_control_panel.home_alarm', 'disarmed') }}
        icon_template: mdi:alarm-light


  - platform: template
    sensors:
      dss_alarm_notte_attivo:
        friendly_name: "Allarme nottuno attivato"
        icon_template: mdi:alarm-light
        value_template: >-
          {{ is_state('binary_sensor.dss_mode_giorno', 'off') and not is_state('alarm_control_panel.home_alarm', 'disarmed') }}

group:
  allarme:
    name: "Sicurezza Casa"
    entities:
      - group.stato_allarme
      - group.dss_dispositivi_tracciati
      - group.stato_infissi
      #qui si possono inserire altri gruppi, anche definiti in altri package... tipo quello del sensore allagamento

  stato_allarme:
    name: "Stato allarme"
    entities:
      - alarm_control_panel.home_alarm
      #cancella se non hai gateway
      - group.stato_gateway_service
      #cancella se non hai mediaplayer
      - group.stato_mediaplayer_service
      - group.dss_automazioni_allarme
      - group.dss_notifiche_allarme
      - group.dss_avvisi_tts
      - switch.ok_google_mo_torno

  dss_automazioni_allarme:
    name: "Automazioni globali Allarme"
    icon: mdi:cog
    entities:
      # - automation.accendi_lampeggiante_ad_attivazione_away_avvenuta
      # - automation.spegni_lampeggiante_ad_attivazione_avvenuta
      - input_boolean.dss_lights_on_away_mode
      - input_boolean.dss_lights_on_disarmed_mode
      - automation.attivazione_automatica_se_dispositivi_non_in_casa
      - automation.disattivazione_automatica_se_rientra_dispositivo
      # - automation.accendi_flash_gateway_verde_su_disattivazione
      # - automation.conferma_infissi_chiusi_su_doppio_click_pulsante_ingresso
      # - automation.accendi_sonoff_combinatore_gms_su_allarme

  dss_stato_sensori_immediati_home:
    name: "Sensori immediati"
    icon: mdi:cog
    entities: !secret sensori_che_fanno_scattare_allarme_home_mode

  dss_stato_sensori_immediati_away:
    name: "Sensori immediati"
    icon: mdi:cog
    entities: !secret sensori_che_fanno_scattare_allarme_away_mode

  dss_stato_sensori_ritardati_home:
    name: "Sensori ritardati"
    icon: mdi:cog
    entities: !secret entity_sensore_innesco_ritardato_allarme_away

  dss_stato_sensori_ritardati_away:
    name: "Sensori ritardati"
    icon: mdi:clock
    entities: !secret entity_sensore_innesco_ritardato_allarme_home

script:
###########Ritardo l'inserimento di 30 secondi se gli infissi sono aperti                    
  # infissi aperti attivo click singolo per sapere quali sono aperti, imposto il boolean per forzare l'attivazione e faccio partire il timer per l'annullamento.
  dss_procedura_attivazione_infissi_aperti:
    alias: "Procedura su attivazione con infissi aperti"
    sequence:
      - service: script.dss_voice_riproduci_messaggio_tts
        data:
          message: "Attenzione, alcuni infissi sono aperti... Clicca per l'elenco"
      - service: script.dss_alarm_script_accendi_luci_segnalazione
        data:
          color_name: "orange"
      - service: input_boolean.turn_on
        data:
          entity_id: input_boolean.dss_necessaria_forzatura_attivazione
      - service: automation.turn_on
        data:
          entity_id: automation.elenca_infissi_aperti_su_click_pulsanti_away
      - service: automation.turn_on
        data:
          entity_id: automation.elenca_infissi_aperti_su_click_pulsanti_home
      - service: automation.turn_on
        data:
          entity_id: automation.forza_attivazione_allarme_away_con_doppio_click_pulsante_ingresso
      - service: automation.turn_on
        data:
          entity_id: automation.forza_attivazione_allarme_home_con_doppio_click_pulsanti_comodino

  dss_procedura_reset_attivazione_rimandata:
    alias: "Procedura reset attivazione rimandata"
    sequence:
      - condition: template
        value_template: "{{ not is_state('alarm_control_panel.home_alarm', 'pending') and not is_state('alarm_control_panel.home_alarm', 'arming') }}"
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.dss_necessaria_forzatura_attivazione
      - service: automation.turn_off
        data:
          entity_id: automation.elenca_infissi_aperti_su_click_pulsanti_away
      - service: automation.turn_off
        data:
          entity_id: automation.elenca_infissi_aperti_su_click_pulsanti_home
      - service: automation.turn_off
        data:
          entity_id: automation.forza_attivazione_allarme_away_con_doppio_click_pulsante_ingresso
      - service: automation.turn_off
        data:
          entity_id: automation.forza_attivazione_allarme_home_con_doppio_click_pulsanti_comodino
      #cancella se non hai gateway 
      - service: script.dss_alarm_gateway_service_light_off
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_light_off

  dss_play_triggered_sound_day:
    alias: "GIORNO: Riproduci suono 'Allarme'"
    sequence:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'on'
      - condition: state
        entity_id: input_boolean.dss_mute_gateway_sounds
        state: 'off'
      #cancella se non hai gateway  
      - service: script.dss_alarm_gateway_service_play_triggered_sound_day
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_play_triggered_sound_day

  dss_play_pending_sound_day:
    alias: "GIORNO: Riproduci suono 'In Attivazione'"
    sequence:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'on'
      - condition: state
        entity_id: input_boolean.dss_mute_gateway_sounds
        state: 'off'
      #cancella se non hai gateway 
      - service: script.dss_alarm_gateway_service_play_pending_sound_day
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_play_pending_sound_day

  dss_play_disarmed_sound_day:
    alias: "GIORNO: Riproduci suono 'Disarmato'"
    sequence:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'on'
      - condition: state
        entity_id: input_boolean.dss_mute_gateway_sounds
        state: 'off'
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_play_disarmed_sound_day
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_play_disarmed_sound_day

### Scripts to play gateway sounds ###
  dss_play_triggered_sound_night:
    alias: "NOTTE: Riproduci suono 'Allarme'"
    sequence:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'off'
      - condition: state
        entity_id: input_boolean.dss_mute_gateway_sounds
        state: 'off'
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_play_triggered_sound_night
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_play_triggered_sound_night

  dss_play_pending_sound_night:
    alias: "NOTTE: Riproduci suono 'In Attivazione'"
    sequence:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'off'
      - condition: state
        entity_id: input_boolean.dss_mute_gateway_sounds
        state: 'off'
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_play_pending_sound_night
      #cancella se non hai  mediaplayer
      - service: script.dss_alarm_mediaplayer_service_play_pending_sound_night

  dss_play_disarmed_sound_night:
    alias: "NOTTE: Riproduci suono 'Disarmato'"
    sequence:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'off'
      - condition: state
        entity_id: input_boolean.dss_mute_gateway_sounds
        state: 'off'
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_play_disarmed_sound_night
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_play_disarmed_sound_night
      
# CANCEL Siren when Disarm - refer to Automation
  dss_triggered_sound_cancel:
    alias: "Silenzia e spegni Allarme"
    sequence:
      - delay:
          seconds: 2
      - service: script.turn_off
        data:
          entity_id: script.dss_play_triggered_sound_day
      - service: script.turn_off
        data:
          entity_id: script.dss_play_triggered_sound_night
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_ferma_riproduzione_suoni
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_ferma_riproduzione_suoni


### le righe seguenti servono per la gestione di una smart plug collegata ad una sirena esterna
      # - service: switch.turn_off
        # data:
          # entity_id: !secret entity_smart_plug

  # dss_turn_on_smart_plug_day:
    # alias: "GIORNO: Accendi Smart Plug"
    # sequence:
      # - condition: state
        # entity_id: binary_sensor.dss_mode_giorno
        # state: 'on'
      # - condition: state
        # entity_id: input_boolean.dss_mute_gateway_sounds
        # state: 'off'
      # - service: switch.turn_on
        # data:
          # entity_id: !secret entity_smart_plug

  # dss_turn_on_smart_plug_night:
    # alias: "NOTTE: Accendi Smart Plug"
    # sequence:
      # - condition: state
        # entity_id: binary_sensor.dss_mode_giorno
        # state: 'OFF'
      # - condition: state
        # entity_id: input_boolean.dss_mute_gateway_sounds
        # state: 'off'
      # - service: switch.turn_on
        # data:
          # entity_id: !secret entity_smart_plug

############################################################
###          ALARM TRIGGER START FLASHING LIGHT          ###
############################################################

  # START FLASH  
  dss_light_flash:
    alias: "Accendi luce lampeggiante in 'Allarme'"
    sequence:
      - alias: dss_light_flash_loop
        repeat:
          while:
            - condition: state
              entity_id: input_boolean.dss_mute_gateway_sounds
              state: 'off'
          sequence:
            #cancella se non hai gateway
            - service: script.dss_alarm_gateway_service_light_flash
            #cancella se non hai mediaplayer
            - service: script.dss_alarm_mediaplayer_service_light_flash
            - delay:
              #### time for flash light on
                seconds: 2
            #cancella se non hai gateway
            - service: script.dss_alarm_gateway_service_light_off
            #cancella se non hai mediaplayer
            - service: script.dss_alarm_mediaplayer_service_light_off
            - delay:
              #### time for flash light off
                seconds: .02

  # CANCEL FLASHING 
  dss_light_flash_cancel:
    alias: "Spegni luce lampeggiante in 'Allarme'"
    sequence:
      - delay:
          seconds: 2
      - service: script.turn_off
        data:
          entity_id: script.dss_light_flash
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_light_off
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_light_off

############################################################
###          ALARM AWAY START FLASHING LIGHT             ###
############################################################

  # START FLASH  
  dss_light_flash_away:
    alias: "Accendi luce lampeggiante in 'Allarme' AWAY"
    sequence:
      - condition: state
        entity_id: input_boolean.dss_lights_on_away_mode
        state: 'on'
      - alias: dss_light_flash_loop_away
        repeat:
          while:
            - condition: state
              entity_id: alarm_control_panel.home_alarm
              state: armed_away
          sequence:
            #cancella se non hai gateway
            - service: script.dss_alarm_gateway_service_light_flash_away
            #cancella se non hai mediaplayer
            - service: script.dss_alarm_mediaplayer_service_light_flash_away
            - delay:
              #### time for flash light on
                seconds: 2
            #cancella se non hai gateway
            - service: script.dss_alarm_gateway_service_light_off
            #cancella se non hai mediaplayer
            - service: script.dss_alarm_mediaplayer_service_light_off
            - delay:
                seconds: .02

  # CANCEL FLASHING 
  dss_light_flash_cancel_away:
    alias: "Spegni luce lampeggiante in 'Allarme' AWAY"
    sequence:
      - delay:
          seconds: 2
      - service: script.turn_off
        data:
          entity_id: script.dss_light_flash_away
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_light_off
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_light_off

automation:
  # - alias: "Accendi SONOFF combinatore GMS su ALLARME"
    # initial_state: true
    # trigger:
      # platform: state
      # entity_id: alarm_control_panel.home_alarm
      # to: 'triggered'
    # action:
      # - xxxxxxxxxxxxxxxx

  - alias: "Accendi flash verde su disattivazione"
    initial_state: true
    trigger:
      - platform: state
        entity_id: alarm_control_panel.home_alarm
        to: 'disarmed'
    condition:
      - condition: state
        entity_id: input_boolean.dss_lights_on_disarmed_mode
        state: 'on'
    action:
      - repeat:
          count: 5
          sequence:
            - service: script.dss_alarm_script_accendi_luci_segnalazione
              data:
                color_name: "green"
            - delay:
                seconds: 2
            - service: script.dss_alarm_script_spegni_luci_segnalazione
            - delay:
                seconds: .02


  - alias: "Avviso infissi aperti su doppio click pulsante ingresso"
    initial_state: true
    trigger:
      - platform: event
        event_type: xiaomi_aqara.click
        event_data:
          click_type: double
          entity_id: !secret entity_pulsante_attiva_allarme_away
    condition:
      - condition: template
        value_template: >
          {%- macro controllo_sensori() -%}
          {%- set exclusions = state_attr('input_select.dss_binary_sensor_secrets_ignora_controllo_infissi_chiusi_away', 'options') -%}
          {%- set device_types = ['door', 'garage_door', 'lock', 'opening', 'window'] -%}
          {%- for item in expand(states['binary_sensor']) if (item.name not in exclusions and item.entity_id not in exclusions) if (item.state == 'on' and item.attributes['device_class'] in device_types) -%}
          {{ item.entity_id }},
          {%- endfor -%}
          {%- endmacro -%}
          {{ controllo_sensori() | trim != "" }}
    action:
      - service: script.dss_procedura_attivazione_infissi_aperti
      - delay:
          seconds: 30
      - service: script.dss_procedura_reset_attivazione_rimandata
      - service: script.dss_alarm_gateway_service_light_off
      - service: script.dss_alarm_mediaplayer_service_light_off
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.dss_necessaria_forzatura_attivazione
      - service: alarm_control_panel.alarm_arm_away
        data:
          entity_id: alarm_control_panel.home_alarm
        
  - alias: "Avviso infissi aperti su doppio click pulsanti comodino"
    initial_state: true
    trigger:
      - platform: event
        event_type: xiaomi_aqara.click
        event_data:
          click_type: double
          entity_id: !secret entity_pulsante_attiva_allarme_home
    condition:
      - condition: template
        value_template: >
          {%- macro controllo_sensori() -%}
          {%- set exclusions = state_attr('input_select.dss_binary_sensor_secrets_ignora_controllo_infissi_chiusi_home', 'options') -%}
          {%- set device_types = ['door', 'garage_door', 'lock', 'opening', 'window'] -%}
          {%- for item in expand(states['binary_sensor']) if (item.name not in exclusions and item.entity_id not in exclusions) if (item.state == 'on' and item.attributes['device_class'] in device_types) -%}
          {{ item.entity_id }},
          {%- endfor -%}
          {%- endmacro -%}
          {{ controllo_sensori() | trim != "" }}
    action:
      - service: script.dss_procedura_attivazione_infissi_aperti
      - delay:
          seconds: 30
      - service: script.dss_procedura_reset_attivazione_rimandata
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_light_off
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_light_off
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.dss_necessaria_forzatura_attivazione
      - service: alarm_control_panel.alarm_arm_home
        data:
          entity_id: alarm_control_panel.home_alarm
        
  ###ho un pulsante all'ingresso. lo uso per attivare l'allarme MANUALMENTE in AWAY mode con DOPPIO CLICK
  - alias: "Forza attivazione Allarme AWAY con DOPPIO CLICK Pulsante ingresso"      
    initial_state: false
    trigger:
      - platform: event
        event_type: xiaomi_aqara.click
        event_data:
          click_type: double
          entity_id: !secret entity_pulsante_attiva_allarme_away
    condition:
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: disarmed
      - condition: state
        entity_id: input_boolean.dss_necessaria_forzatura_attivazione
        state: 'on'
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.dss_necessaria_forzatura_attivazione
      - service: alarm_control_panel.alarm_arm_away
        data:
          entity_id: alarm_control_panel.home_alarm
          
  ###ho due pulsanti sui comodini. li uso per attivare l'allarme MANUALMENTE in HOME mode con DOPPIO CLICK
  - alias: "Forza attivazione Allarme HOME con DOPPIO CLICK Pulsanti comodino"      
    initial_state: true
    trigger:
      - platform: event
        event_type: xiaomi_aqara.click
        event_data:
          click_type: double
          entity_id: !secret entity_pulsante_attiva_allarme_home
    condition:
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: disarmed
      - condition: state
        entity_id: input_boolean.dss_necessaria_forzatura_attivazione
        state: 'on'
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.dss_necessaria_forzatura_attivazione
      - service: alarm_control_panel.alarm_arm_home
        data:
          entity_id: alarm_control_panel.home_alarm     

  - alias: "Innesca se armato AWAY"
    initial_state: true
    trigger:
      - platform: state
        from: 'off'
        to: 'on'
        entity_id: !secret sensori_che_fanno_scattare_allarme_away_mode
    condition:
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: armed_away
    action:
      - service: alarm_control_panel.alarm_trigger
        entity_id: alarm_control_panel.home_alarm 
       
  - alias: "Innesca se armato HOME"
    initial_state: true
    trigger:
      - platform: state
        from: 'off'
        to: 'on'
        entity_id: !secret sensori_che_fanno_scattare_allarme_home_mode
    condition:
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: armed_home
    action:
      - service: alarm_control_panel.alarm_trigger
        entity_id: alarm_control_panel.home_alarm 

  - alias: "Attivazione automatica se Dispositivi non in Casa"
    initial_state: false
    trigger:
      - platform: state
        entity_id: group.dss_dispositivi_tracciati
        from: 'home'
        to: 'not_home'
        for:
          minutes: 5
    condition:
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: disarmed
      - condition: state
        entity_id: input_boolean.dss_sospesa_attivazione_automatica
        state: 'off'
    action:
      - service: alarm_control_panel.alarm_arm_away
        data:
          entity_id: alarm_control_panel.home_alarm     
           
  - alias: "Disattivazione automatica se rientra Dispositivo"      
    initial_state: true
    trigger:
      - platform: state
        entity_id: group.dss_dispositivi_tracciati
        from: 'not_home'
        to: 'home'
        for:
          seconds: 15
    condition:
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: armed_away
    action:
      - service: alarm_control_panel.alarm_disarm
        data:
          entity_id: alarm_control_panel.home_alarm
          
  - alias: "Disattivazione sospensione attivazione automatica se rientra Dispositivo" 
    initial_state: true
    trigger:
      - platform: state
        entity_id: group.dss_dispositivi_tracciati
        from: 'not_home'
        to: 'home'
        for:
          seconds: 15
    condition:
      - condition: state
        entity_id: input_boolean.dss_sospesa_attivazione_automatica
        state: 'on'
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.dss_sospesa_attivazione_automatica

  ###Disattivo MANUALMENTE l'allarme con uno dei tre plusanti PREMUTI A LUNGO
  - alias: "Disattiva Allarme con LONG CLICK Pulsanti"      
    initial_state: true
    trigger:
      - platform: event
        event_type: xiaomi_aqara.click
        event_data:
          click_type: long_click_press 
          entity_id: !secret entity_pulsante_attiva_allarme_home
      - platform: event
        event_type: xiaomi_aqara.click
        event_data:
          click_type: long_click_press 
          entity_id: !secret entity_pulsante_attiva_allarme_away
    condition:
      condition: template
      value_template: "{{ not is_state('alarm_control_panel.home_alarm', 'disarmed') }}"
    action:
      - service: alarm_control_panel.alarm_disarm
        data:
          entity_id: alarm_control_panel.home_alarm

  ### Play specific sound while alarm is arming ###
  - alias: "Attivazione allarme in corso"
    initial_state: true
    trigger:
      - platform: state
        entity_id: alarm_control_panel.home_alarm
        from: 'disarmed'
        to: 'arming'
    action:
      ### Turn off gateway mute to play sound ###
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.dss_mute_gateway_sounds
      - service: script.dss_play_pending_sound_day
      - service: script.dss_play_pending_sound_night
      - service: script.dss_light_flash_cancel_away
      - service: script.dss_light_flash

  ### Disattiva allarme, blocco i suoni ed il lampeggiante ###    
  - alias: "Ferma suoni e luci quando disarmato"
    initial_state: true
    trigger:
      - platform: state
        entity_id: alarm_control_panel.home_alarm
        to: 'disarmed'
    action:
      - service: input_boolean.turn_on
        data:
          entity_id: input_boolean.dss_mute_gateway_sounds
      - service: script.dss_light_flash_cancel
      - service: script.dss_light_flash_cancel_away
      - service: script.dss_triggered_sound_cancel
      - delay:
          seconds: 2
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.dss_mute_gateway_sounds
      - service: script.dss_play_disarmed_sound_day
      - service: script.dss_play_disarmed_sound_night

  ### Blocco i suoni dopo che l'allarme non è stato disinserito entro i 120sec  ###    
  - alias: "Ferma suoni dopo 120 sec di 'Allarme'"
    initial_state: true
    trigger:
      - platform: state
        entity_id: alarm_control_panel.home_alarm
        from: 'triggered'
        to: 'armed_away'
    action:
      - service: input_boolean.turn_on
        data:
          entity_id: input_boolean.dss_mute_gateway_sounds
      - service: script.dss_triggered_sound_cancel
      - service: script.dss_light_flash_cancel
      - service: script.dss_light_flash_cancel_away
      - delay:
          seconds: 10
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.dss_mute_gateway_sounds
### questi sono i componenti che mandano le notifiche - controlla i nomi dei propri servizi di notifica ###
      - service: script.dss_alarm_script_invia_notifiche
        data:
          message: "ALLARME silenziato e RIARMATO in automatico!"

      #spengo il lampeggiante quando armato AWAY, HOME o DISARMATO
  - alias: "Spegni lampeggiante ad attivazione avvenuta"
    initial_state: true
    trigger:
      - platform: state
        entity_id: alarm_control_panel.home_alarm
        to: 'armed_away'
        for:
          seconds: 30
      - platform: state
        entity_id: alarm_control_panel.home_alarm
        to: 'armed_home'
        for:
          seconds: 30
      - platform: state
        entity_id: alarm_control_panel.home_alarm
        to: 'disarmed'
    action:
      ### Turn off gateway mute to play sound ###
      - delay: '00:00:30'
      - service: input_boolean.turn_on
        data:
          entity_id: input_boolean.dss_mute_gateway_sounds
      - service: script.dss_light_flash_cancel
      - service: script.dss_light_flash_cancel_away
   
  #Accendo il lampeggiante quando armato AWAY, HOME o DISARMATO
  - alias: "Accendi lampeggiante ad attivazione AWAY avvenuta"
    initial_state: false
    trigger:
      - platform: state
        entity_id: alarm_control_panel.home_alarm
        to: 'armed_away'
        for:
          seconds: 60
    action:
      ### Turn off gateway mute to play sound ###
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.dss_mute_gateway_sounds
      - delay: '00:00:30'
      - service: script.dss_light_flash_away

  ### questi sono i trigger che fanno scattare la riproduzione del suono di giorno ###
  - alias: "GIORNO: Riproduci 'Promemoria Allarme AWAY'"
    initial_state: true
    trigger:
      - platform: state
        from: 'off'
        to: 'on'
        entity_id: !secret entity_sensore_promemoria_allarme_attivato_away
    condition:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'on'
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: 'armed_away'
    action:
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_script_giorno_riproduci_promemoria_allarme_away
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_script_giorno_riproduci_promemoria_allarme_away
       
  ### questi sono i trigger che fanno scattare la riproduzione del suono di giorno ###
  - alias: "GIORNO: Riproduci 'Promemoria Allarme HOME'"
    initial_state: true
    trigger:
      - platform: state
        from: 'off'
        to: 'on'
        entity_id: !secret entity_sensore_promemoria_allarme_attivato_home
    condition:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'on'
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: 'armed_home'
    action:
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_script_giorno_riproduci_promemoria_allarme_home
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_script_giorno_riproduci_promemoria_allarme_home
       
  - alias: "GIORNO: Innesco Sensori ritardati Allarme AWAY"
    initial_state: true
    trigger:
      - platform: state
        from: 'off'
        to: 'on'
        entity_id: !secret entity_sensore_innesco_ritardato_allarme_away
    condition:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'on'
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: 'armed_away'
    action:
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_script_giorno_sensore_innesco_ritardato_allarme_away
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_script_giorno_sensore_innesco_ritardato_allarme_away
       
  - alias: "GIORNO: Innesco Sensori ritardati Allarme HOME"
    initial_state: true
    trigger:
      - platform: state
        from: 'off'
        to: 'on'
        entity_id: !secret entity_sensore_innesco_ritardato_allarme_home
    condition:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'on'
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: 'armed_home'
    action:
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_script_giorno_sensore_innesco_ritardato_allarme_home
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_script_giorno_sensore_innesco_ritardato_allarme_home
       
  ### Riproduci suono 'Allarme' quando scatta di giorno###
  - alias: "Riproduci suono 'Allarme' quando scatta di giorno"
    initial_state: true
    trigger:
      - platform: state
        entity_id: alarm_control_panel.home_alarm
        to: 'triggered'
    condition:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'on'
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.dss_mute_gateway_sounds
      - service: script.dss_play_triggered_sound_day
      - service: script.dss_light_flash

          ### questi sono i trigger che fanno scattare la riproduzione del suono di  notte###
  - alias: "NOTTE: Riproduci 'Promemoria Allarme AWAY'"
    initial_state: true
    trigger:
      - platform: state
        from: 'off'
        to: 'on'
        entity_id: !secret entity_sensore_promemoria_allarme_attivato_away
    condition:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'off'
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: 'armed_away'
    action:
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_script_notte_riproduci_promemoria_allarme_away
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_script_notte_riproduci_promemoria_allarme_away

  - alias: "NOTTE: Riproduci 'Promemoria Allarme HOME'"
    initial_state: true
    trigger:
      - platform: state
        from: 'off'
        to: 'on'
        entity_id: !secret entity_sensore_promemoria_allarme_attivato_home
    condition:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'off'
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: 'armed_away'
    action:
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_script_notte_riproduci_promemoria_allarme_home
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_script_notte_riproduci_promemoria_allarme_home

  - alias: "NOTTE: Innesco Sensori ritardati Allarme AWAY"
    initial_state: true
    trigger:
      - platform: state
        from: 'off'
        to: 'on'
        entity_id: !secret entity_sensore_innesco_ritardato_allarme_away
    condition:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'off'
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: 'armed_away'
    action:
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_script_notte_sensore_innesco_ritardato_allarme_away
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_script_notte_sensore_innesco_ritardato_allarme_away
       
  - alias: "NOTTE: Innesco Sensori ritardati Allarme HOME"
    initial_state: true
    trigger:
      - platform: state
        from: 'off'
        to: 'on'
        entity_id: !secret entity_sensore_innesco_ritardato_allarme_home
    condition:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'off'
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: 'armed_home'
    action:
      #cancella se non hai gateway
      - service: script.dss_alarm_gateway_service_script_notte_sensore_innesco_ritardato_allarme_home
      #cancella se non hai mediaplayer
      - service: script.dss_alarm_mediaplayer_service_script_notte_sensore_innesco_ritardato_allarme_home
       
### Riproduci suono 'Allarme' quando scatta di notte###
  - alias: "Riproduci suono 'Allarme' quando scatta di notte"
    initial_state: true
    trigger:
      - platform: state
        entity_id: alarm_control_panel.home_alarm
        to: 'triggered'
    condition:
      - condition: state
        entity_id: binary_sensor.dss_mode_giorno
        state: 'off'
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.dss_mute_gateway_sounds
      - service: script.dss_play_triggered_sound_night
      - service: script.dss_light_flash

### Queste le key da personalizzare ed inserire nel file secrets.yaml

# ############ DSS XIAOMI ALARM #############

### secret per attivare il menù di comando dell'allarme con Telegram
# dss_triggers_menu_telegram_command_allarme: '/alarm'

# ### MAC Address del primo Gateway Xiaomi. Notare la mancanza di separatori (:) e la scrittura in minuscolo.
# xiaomi_gateway1_mac: 11aa222b33cd

# ### se avete ulteriori gateway dovete inserirne i mac address
# ### xiaomi_gateway2_mac: 22xx222x33xx


# ### URL di un'immagine da associare agli utenti tracciati
# url_immagine_profilo_user1: "https://graph.facebook.com/xxxxxxxxx/picture?type=normal"
# url_immagine_profilo_user2: "https://www.facebook.com/search/async/profile_picture/?fbid=xxxxxxxxx&width=100&height=100"


# ### se avete ulteriori utenti, definite anche le loro immagini. Nulla vi vieta di usare immagini locali
# ### url_immagine_profilo_user3: "/local/www/foto.jpg"

# ### Entity_id della luce del Gateway1
# entity_light_gateway1: light.gateway_light_xxxxxxxxxxxxxx

# ### se avete ulteriori gateway... sapete cosa fare

# ### Entity_id di un sensore o di un gruppo di sensori che al cambio di stato da OFF ad ON, in caso di allarme attivo, farà riprodurre un avviso di allarme ATTIVO.
# ### Notate che è possibile usare un entity_id singolo o un array. Se non si desidera utilizzare tale funzionalità basterà inserire un array vuoto: [ ]
# entity_sensore_promemoria_allarme_attivato_away: binary_sensor.door_window_sensor_xxxxxxxxx
# entity_sensore_promemoria_allarme_attivato_home: [
# binary_sensor.motion_sensor_xxxxxxxxxxxxxx, 
# binary_sensor.motion_sensor_yyyyyyyyyyyyyy
# ]
# ### Entity_id di un sensore o di un gruppo di sensori che al cambio di stato da OFF ad ON, in caso di allarme attivo, farà riprodurre un avviso di allarme ATTIVO e DOPO 30 secondi farà innescare l'allarme.
# entity_sensore_innesco_ritardato_allarme_away: binary_sensor.door_window_sensor_xxxxxxxxxx
# entity_sensore_innesco_ritardato_allarme_home: []

# ### Entity_id di un sensore o di un gruppo di sensori che, in fase di attivazione dell'allarme non dovranno essere considerati nel controllo dell'apertura. 
# ### Cioè non ne verrà segnalata l'apertura mediante avvisi luminosi, TTS o Notifiche (Telegram e/o HTML5)
### ATTENZIONE: se non deve essere ignorata nessuna entity_id, assicurati di mettere almeno un valore. es: ['Nessuna']
# dss_binary_sensor_secrets_ignora_controllo_infissi_chiusi_home: [binary_sensor.door_window_sensor_wwwwwwwwwwwwww]
# dss_binary_sensor_secrets_ignora_controllo_infissi_chiusi_away: [binary_sensor.door_window_sensor_wwwwwwwwwwwwww, binary_sensor.door_window_sensor_zzzzzzzzzzzzzz]

# ### Entity_id di un sensore o di un gruppo di sensori che, in fase di attivazione dell'allarme non dovranno essere considerati nel controllo luci accese. 
# ### Cioè non ne verrà segnalata l'apertura mediante Notifiche (Telegram e/o HTML5)
### ATTENZIONE: se non deve essere ignorata nessuna entity_id, assicurati di mettere almeno un valore. es: ['Nessuna']
# dss_binary_sensor_secrets_ignora_controllo_luci_accese_home: ['Nessuna']
# dss_binary_sensor_secrets_ignora_controllo_luci_accese_away: [switch.xxxxxxxxxxx, light.yyyyyyyyyyyyy, 'Nome Luce']

# ### Entity_id di un sensore o di un gruppo di sensori che, in fase di attivazione dell'allarme non dovranno essere considerati nel controllo climatizzatore acceso. 
# ### Cioè non ne verrà segnalata l'apertura mediante Notifiche (Telegram e/o HTML5)
### ATTENZIONE: se non deve essere ignorata nessuna entity_id, assicurati di mettere almeno un valore. es: ['Nessuna']
# dss_binary_sensor_secrets_ignora_controllo_clima_acceso_home: ['Nessuno']
# dss_binary_sensor_secrets_ignora_controllo_clima_acceso_away: [climate.yyyyyyyyyyyyy, 'Nome Clima']

# ### Entity_id di un sensore o di un gruppo di sensori che attivano/disattivano l'allarme. 
# ### Ovviamente sarà possibile specificare entity_id singoli, gruppi (mediante array [ ]), o array vuoti ([ ]).
# entity_pulsante_attiva_allarme_home: [binary_sensor.switch_aaaaaaaaaaaaaa, binary_sensor.switch_bbbbbbbbbbbbbb]
# entity_pulsante_attiva_allarme_away: binary_sensor.switch_cccccccccccccc
# ### Entity_id di un sensore o di un gruppo di sensori che innescano l'allarme se attivo in modalità HOME. 
# sensori_che_fanno_scattare_allarme_home_mode: [
# binary_sensor.door_window_sensor_zzzzzzzzzzzzzz, 
# binary_sensor.door_window_sensor_jjjjjjjjjjjjjj, 
# binary_sensor.door_window_sensor_wwwwwwwwwwwwww
# ]
# ### Entity_id di un sensore o di un gruppo di sensori che innescano l'allarme se attivo in modalità AWAY. 
# sensori_che_fanno_scattare_allarme_away_mode: [
# binary_sensor.motion_sensor_xxxxxxxxxxxxxx, 
# binary_sensor.motion_sensor_yyyyyyyyyyyyyy, 
# binary_sensor.door_window_sensor_zzzzzzzzzzzzzz, 
# binary_sensor.door_window_sensor_jjjjjjjjjjjjjj, 
# binary_sensor.door_window_sensor_wwwwwwwwwwwwww
# ]

# ### Nome del Gruppo dei dispositivi dell'utente 1. Deve cominciare con "Dispositivi "
# nome_gruppo_dispositivi_utente1: "Dispositivi VOSTRO NOME" 

# ### Entity_id di un device_tracker o di un gruppo di device_tracker che devono essere tracciati per l'utente 1. 
# elenco_dispositivi_tracciati_user1: [
# device_tracker.redmi_note_4_ip,
# device_tracker.redmi_note_4_bt,
# sensor.tracker_Nut_utente1
# ]
# ### Nome del Gruppo dei dispositivi dell'utente 1. Deve cominciare con "Dispositivi "
# nome_gruppo_dispositivi_utente2: "Dispositivi NOME ALTRO UTENTE"
# ### Entity_id di un device_tracker o di un gruppo di device_tracker che devono essere tracciati per l'utente 2
# elenco_dispositivi_tracciati_user2: [
# device_tracker.redmi_note_6_pro_ip,
# device_tracker.redmi_note_6_pro_bt,
# sensor.tracker_Nut_utente2
# ]
# ### Se utilizzate il tracker ESP32 con Ble2Mqtt specificate il nome dei tracker ed i Topic MQTT
# nome_dispositivo_nut_tracker_user1: "Tracker Nut Utente1"
# topic_dispositivo_nut_tracker_user1: "xxxxxx/sensor/casa/xxxxxx/state"

# nome_dispositivo_nut_tracker_user2: "Tracker Nut Utente2"
# topic_dispositivo_nut_tracker_user2: "xxxxxx/sensor/casa/xxxxxx/state"

### esempio contenuto editor grezzo LOVELACE

  # - badges: []
    # cards:
      # - entity: alarm_control_panel.home_alarm
        # type: alarm-panel
      # - entities:
          # - group.dss_dispositivi_user1
          # - group.dss_dispositivi_user2
          # - group.dss_automazioni_allarme
          # - group.dss_notifiche_allarme
          # - group.dss_avvisi_tts
          # - switch.ok_google_mo_torno
        # show_header_toggle: false
        # title: Impostazioni Allarme
        # type: entities
      # - entities:
          # - entity: group.dss_mediaplayer1_allarme_diurno
          # - entity: group.dss_mediaplayer1_allarme_notturno
          # - entity: group.dss_automazioni_allarme
          # - entity: group.dss_mediaplayer1_promemoria_allarme
          # - entity: group.dss_mediaplayer1_sensori_ritardati
        # show_header_toggle: false
        # title: Stato allarme Gateway 1
        # type: entities
      # - entities:
          # - entity: group.dss_gateway1_allarme_diurno
          # - entity: group.dss_gateway1_allarme_notturno
          # - entity: group.dss_automazioni_allarme
          # - entity: group.dss_gateway1_promemoria_allarme
          # - entity: group.dss_gateway1_sensori_ritardati
        # show_header_toggle: false
        # title: Stato allarme Gateway 1
        # type: entities
      # - entities:
          # - entity: group.dss_gateway2_allarme_diurno
          # - entity: group.dss_gateway2_allarme_notturno
          # - entity: group.dss_automazioni_allarme
          # - entity: group.dss_gateway2_promemoria_allarme
          # - entity: group.dss_gateway2_sensori_ritardati
        # show_header_toggle: false
        # title: Stato allarme Gateway 2
        # type: entities
    # path: allarme
    # title: Sicurezza Casa
